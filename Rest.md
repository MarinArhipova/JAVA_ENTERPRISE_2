# REST API

* API (Application Programming Interface) - набор некоторых функций, предоставляемых программных модулем. Например, библиотека lombok предоставляет в качестве API - набор различных аннотаций, библиотека javax.servlet предоставляет концепцию сервлетов, spring boot предоставляет возможности автоконфигурирования, vk.com предоставляет возможность сторонним приложениям работать с их соц. сетью.


* Часто, приложения имеют архитектуру MVC, таким образом фронтэнд часть предоставляет самим сервером в виде вьюшек.

* Но, есть архитектуры, которые разделяют все приложения на две части - backend и frontend. Эти две независимые части общаются между собой с помощью определенного API предоставляемого сервером. Эти две части - независимые приложения.

## Rest API

* Свод правил по оформлению HTTP API сервера.

1) Сервер не хранит состояния.
2) Сервер не отвечает за то, как будет выглядеть frontend.
3) Сервер предоставлят набор HTTP-запросов для общения с клиентом (frontend-приложением)
4) Каждый запрос использует семантику HTTP-глагола для выполнения какой-либо операции.
5) Все запросы ориентированы на ресурсы.
6) Сервер принимает и отдает данные в общепринятом формате обмена данными - предпочтительно в формте JSON.

## Примеры

Интернет-магазин

* Добавить товар в магазин

```
POST
http://localhost/products

{
	"title": "Молоко",
	"price": 60.5
} 

Response:

Status Code: 201
{
	"id" : 1,
	"title": "Молоко",
	"price": 60.5
}
```

* Обновить товар

```
PUT 
http://localhost/products/1

{
	"price": 70
}

Reponse:
Status Code: 200
{
	"id" : 1,
	"title": "Молоко",
	"price": 70
}
```

* Получить товары определенного пользователя

```
GET 
http://localhost/users/344/products

Reponse:
Status Code: 200
[{
	"id" : 1,
	"title": "Молоко",
	"price": 70
}, ...]
```

## Spring Security и Rest-безопасность

### Схема безопасности REST-сервисов

1. Пользователь вводит логин и пароль, отправляет на сервер.

2. Пользователь получает последовательность символов, которая является "токеном".

3. Далее каждый запрос сопровождается данным токеном.

4. Сервер, получив запрос с токеном, может понять, что это за пользователь.

### Реализация данной схемы в Spring Security

* По умолчанию Spring Security реализует авторизацию на сессиях, если хотим что-то свое - нужно переделывать.

```

     ------------------
     HTTP REQUEST
 	 Header: AUTH=token
 	 ------------------
 	     |
 	     V
       [Filter] - принять запрос, и преобразовать его данные в Authentication
         |
         |  <Authentication> (важный параметр isAuthenticated)
         V
 ----->[SecurityContext] - хранить информацию о текущей сущности авторизации
 |       |
 |       |  <Authentication>
 |       V
 |     AuthenticationManager - отправить Authentication нужному провайдеру
 |     |        |          |
 |     V        V          V
 AuthProvider AuthProvider AuthProvider - принять Authentication, и выставить значение isAuthenticated, то есть непосредственно провести аутентификацию
       |        |          |
       V        V          V
    	UserDetailsService - проверть наличие пользователя в системе и вернуть его данные
```

## Компоненты в нашем проекте:

* Authentication (Spring) - интерфейс, описывающий объект аутентификации. Данный объект позволяет: получить права либо роль пользователя, выполневшего запрос; получить авторизационные данные; получить пользователя как объект безопасности; получить самого пользователя; проверить, аутентифицирован ли пользователь; сделать его аутентифицированным;

* TokenAuthentication - класс, имплементирующий Authentication так, как нам надо для работы с токенами.

Содержит:
- Данные о пользователе как об объекте безопасности (Details)
- Значение самого токена
- Флаг аутентификации

* TokenAuthenticationFilter - класс, принимает запрос, достает токен, отдает SecurityContext. Если мы положили в контекст Authentication, то данный запрос сначала уйдет в AuthenticationManager, если нет - то сразу в контроллер (а точнее, в DispatcherServler).

* AuthenticationManager(Spring) - интерфейс, реализацию которого обычно подставляет Spring. Имеет важный метод, данный метод реализован так, что он опрашивает всех провайдеров, которые есть в наличие для поиска подходящего.

```JAVA
Authentication authenticate(Authentication authentication)
			throws AuthenticationException;
```			

* AuthenticationProvider(Spring) - интерфейс, который выполняет непосредственную аутентификацию пользователя.

* TokenAuthenticationProvider - реализация, которая работает с TokenAuthentication-аутентификацией.

* UserDetailsService(Spring) - интерфейс, который позволяет получить UserDetails-объект по какому-либо значению (либо логин, либо email, либо токен либо что-то еще).

* UserDetails(Spring) - интерфейс, описывающий объект, содрежащий информацию о безопаности пользователя - пароль, логин, права, роли, параметры блокировки и т.д.

* UserDetailsImpl - наша реализация UserDetails, адаптированная под нашего пользователя.

* UserDetailsServiceImpl - находит пользователя по его токену.


